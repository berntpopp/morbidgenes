server {
  listen 80 default_server;
  listen [::]:80 default_server;
  server_name _;
  return 301 https://$host$request_uri;
}

server {
  listen [::]:443 ssl http2 ipv6only=on;
  listen 443 ssl http2;

  server_name morbidgenes.org www.morbidgenes.org 85.214.147.195;
  
  ssl_certificate      /etc/nginx/certificates/cert.pem;
  ssl_certificate_key  /etc/nginx/certificates/key.pem;

  ssl_stapling on;
  ssl_stapling_verify on;
  
  resolver 8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout 5s;

  ssl_protocols       TLSv1.2 TLSv1.3;
  ssl_ciphers         "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA HIGH !RC4 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !CAMELLIA";
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 24h;
  ssl_session_tickets off;
  ## Reduce SSL buffer size
  ## https://haydenjames.io/nginx-tuning-tips-tls-ssl-https-ttfb-latency/
  ssl_buffer_size 8k;
  
  limit_req zone=ip burst=30 delay=10;

  ## generate nonce
  set $cspnonce "sby60wf3t2nsmihsptlqikizldzacof1";
  #set_secure_random_alphanum $cspnonce 32;
  ## End generate nonce

  # Security settings
  ## enable HSTS
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  ##Permissions-Policy
  add_header Permissions-Policy "geolocation=(),midi=(),sync-xhr=(),microphone=(),camera=(),magnetometer=(),gyroscope=(),fullscreen=(self),payment=()";
  ## Referrer-Policy
  add_header Referrer-Policy "strict-origin";
  add_header "X-XSS-Protection" "1; mode=block";
  add_header "X-Content-Type-Options" "nosniff";
  add_header "X-Download-Options" "noopen";
  add_header "X-Permitted-Cross-Domain-Policies" "master-only";
  add_header "X-Frame-Options" "SAMEORIGIN";
  add_header "Content-Security-Policy" "default-src 'none'; manifest-src 'self'; img-src 'self' data:; style-src 'self' https://fonts.googleapis.com https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css 'unsafe-inline' ; font-src 'self' 'https://fonts.gstatic.com' 'https://cdn.jsdelivr.net/npm/@mdi/font@latest/fonts/materialdesignicons-webfont.ttf?v=7.2.96' 'https://cdn.jsdelivr.net/npm/@mdi/font@latest/fonts/materialdesignicons-webfont.woff2?v=7.2.96' 'https://cdn.jsdelivr.net/npm/@mdi/font@latest/fonts/materialdesignicons-webfont.woff?v=7.2.96'; script-src 'self'; base-uri 'self'; object-src 'none'; connect-src 'self'; form-action 'self'; prefetch-src 'self'; frame-src 'self'; ";
  add_header "X-Content-Security-Policy" "default-src 'none'; manifest-src 'self'; img-src 'self' data:; style-src 'self' https://fonts.googleapis.com https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css 'unsafe-inline' ; font-src 'self' 'https://fonts.gstatic.com' 'https://cdn.jsdelivr.net/npm/@mdi/font@latest/fonts/materialdesignicons-webfont.ttf?v=7.2.96' 'https://cdn.jsdelivr.net/npm/@mdi/font@latest/fonts/materialdesignicons-webfont.woff2?v=7.2.96' 'https://cdn.jsdelivr.net/npm/@mdi/font@latest/fonts/materialdesignicons-webfont.woff?v=7.2.96'; script-src 'self'; base-uri 'self'; object-src 'none'; connect-src 'self'; form-action 'self'; prefetch-src 'self'; frame-src 'self'; ";
  add_header "Expires" "-1";
  add_header "Cache-Control" "max-age=0, no-cache, no-store, must-revalidate";
  add_header "Pragma" "no-cache";
  # End Security settings

  location / {
    ## inject nonce
    sub_filter_once off;
    sub_filter_types *;
    ## End inject nonce
  
    root   /usr/share/nginx/html;
    index  index.html index.htm;
    try_files $uri $uri/ /index.html;
  }

  location /alb/ {
    proxy_pass http://alb/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  error_page   500 502 503 504  /50x.html;

  location = /50x.html {
    root   /usr/share/nginx/html;
  }

}
